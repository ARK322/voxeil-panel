name: Installer / Uninstaller Safety Check

on:
  push:
  pull_request:

jobs:
  static-safety-check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck python3

      # 1) Bash syntax check
      - name: Bash syntax validation
        run: |
          set -e
          for f in voxeil.sh installer/*.sh uninstaller/*.sh nuke/*.sh; do
            [ -f "$f" ] && bash -n "$f"
          done

      # 2) Shellcheck (logic & antipatterns)
      - name: Shellcheck
        run: |
          shellcheck voxeil.sh installer/*.sh uninstaller/*.sh nuke/*.sh || true

      # 3) Detect dangerous webhook patch patterns (HARD FAIL)
      - name: Detect unsafe webhook patching
        run: |
          set -euo pipefail

          # Only scan files that can actually affect runtime (no docs)
          FILES="$(git ls-files \
            'voxeil.sh' \
            'installer/*.sh' \
            'uninstaller/*.sh' \
            'nuke/*.sh' \
            'scripts/*.sh' \
            '*.yml' '*.yaml' \
            || true)"

          if [ -z "$FILES" ]; then
            echo "⚠️ No matching files found to scan"
            exit 0
          fi

          # 1) Unsafe --type=json usage for webhookconfiguration patch
          if echo "$FILES" | xargs -r grep -nE 'kubectl patch .*webhookconfiguration .*--type=json' ; then
            echo "❌ Unsafe kubectl patch --type=json on webhookconfiguration"
            exit 1
          fi

          # 2) Unsafe webhook array overwrite pattern
          if echo "$FILES" | xargs -r grep -nE '\{"webhooks":\[\{"failurePolicy"' ; then
            echo "❌ Unsafe webhook array overwrite detected"
            exit 1
          fi

      # 4) Detect dangerous RBAC deletion (only system:* or kube-* patterns)
      - name: Detect dangerous RBAC deletes
        run: |
          set -e
          # Only flag deletions of system:* or kube-* RBAC (core cluster RBAC)
          # Safe deletions of voxeil-owned RBAC (controller-bootstrap, user-operator) are allowed
          if grep -R --line-number --exclude-dir=.git --exclude-dir=.github -E 'kubectl delete (clusterrole|clusterrolebinding).*(system:|kube-|cluster-admin)' .; then
            echo "❌ Dangerous clusterrole/clusterrolebinding delete detected (system:* or kube-* or cluster-admin)"
            exit 1
          fi

      # 5) Ensure request-timeout on risky kubectl deletes
      - name: Check kubectl delete safety
        run: |
          set -e
          # Check for kubectl delete commands, excluding DRY-RUN echo statements and comments
          BAD=$(grep -R --line-number 'kubectl delete' installer uninstaller nuke \
            | grep -v 'request-timeout' \
            | grep -v '\[DRY-RUN\]' \
            | grep -v '^[^:]*:[^:]*:.*#' \
            | grep -v 'echo.*kubectl delete' || true)

          if [ -n "$BAD" ]; then
            echo "⚠️ kubectl delete without --request-timeout (excluding DRY-RUN and comments):"
            echo "$BAD"
            exit 1
          fi

      # 6) Infinite loop detection (basic)
      - name: Detect infinite loops
        run: |
          set -euo pipefail
          FILES="$(git ls-files 'voxeil.sh' 'installer/*.sh' 'uninstaller/*.sh' 'nuke/*.sh' 'scripts/*.sh' || true)"
          if [ -z "$FILES" ]; then exit 0; fi
          if echo "$FILES" | xargs -r grep -nE 'while true|while\s+\[\s*1\s*\]' ; then
            echo "❌ Infinite loop detected"
            exit 1
          fi

      # 7) Kyverno bootstrap logic presence check (HARD FAIL)
      - name: Check Kyverno webhook bootstrap logic
        run: |
          set -e
          if ! grep -R 'failurePolicy.*Ignore' installer uninstaller; then
            echo "❌ Kyverno webhook Ignore bootstrap not found"
            exit 1
          fi
          if ! grep -R 'safe_bootstrap_kyverno_webhooks\|disable_admission_webhooks_preflight' installer uninstaller; then
            echo "❌ Kyverno webhook safe bootstrap function not found"
            exit 1
          fi

      # 8) Traefik readiness check presence (HARD FAIL)
      - name: Check Traefik readiness verification
        run: |
          set -e
          if ! grep -R 'TRAEFIK_READY\|Traefik.*Running\|helm-install-traefik' installer; then
            echo "❌ Traefik readiness check not found in installer"
            exit 1
          fi

      # 9) Preflight webhook neutralization in uninstaller (HARD FAIL)
      - name: Check uninstaller preflight webhook neutralization
        run: |
          set -e
          # Check that disable_admission_webhooks_preflight is called early in uninstaller
          if ! grep -B 5 -A 5 'disable_admission_webhooks_preflight' uninstaller/uninstaller.sh | grep -q 'Main uninstaller\|CRITICAL.*Preflight'; then
            echo "❌ Uninstaller may not neutralize webhooks at the very top"
            exit 1
          fi

      - name: Final status
        run: echo "✅ Static installer/uninstaller checks passed"
