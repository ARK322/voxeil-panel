name: Installer / Uninstaller Safety Check

on:
  push:
  pull_request:

jobs:
  static-safety-check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck python3

      # 1) Bash syntax check
      - name: Bash syntax validation
        run: |
          set -e
          for f in voxeil.sh installer/*.sh uninstaller/*.sh nuke/*.sh; do
            [ -f "$f" ] && bash -n "$f"
          done

      # 2) Shellcheck (logic & antipatterns)
      - name: Shellcheck
        run: |
          shellcheck voxeil.sh installer/*.sh uninstaller/*.sh nuke/*.sh || true

      # 3) Detect dangerous webhook patch patterns (HARD FAIL)
      - name: Detect unsafe webhook patching
        run: |
          set -e
          # Exclude .github directory and .git directory from search
          if grep -R --line-number --exclude-dir=.git --exclude-dir=.github -E 'kubectl patch .*webhookconfiguration .*--type=json' .; then
            echo "❌ Unsafe kubectl patch --type=json on webhookconfiguration"
            exit 1
          fi

          if grep -R --line-number --exclude-dir=.git --exclude-dir=.github -E '\{"webhooks":\[\{"failurePolicy"' .; then
            echo "❌ Unsafe webhook array overwrite detected"
            exit 1
          fi

      # 4) Detect dangerous RBAC deletion (only system:* or kube-* patterns)
      - name: Detect dangerous RBAC deletes
        run: |
          set -e
          # Only flag deletions of system:* or kube-* RBAC (core cluster RBAC)
          # Safe deletions of voxeil-owned RBAC (controller-bootstrap, user-operator) are allowed
          if grep -R --line-number --exclude-dir=.git --exclude-dir=.github -E 'kubectl delete (clusterrole|clusterrolebinding).*(system:|kube-|cluster-admin)' .; then
            echo "❌ Dangerous clusterrole/clusterrolebinding delete detected (system:* or kube-* or cluster-admin)"
            exit 1
          fi

      # 5) Ensure request-timeout on risky kubectl deletes
      - name: Check kubectl delete safety
        run: |
          set -e
          # Check for kubectl delete commands, excluding DRY-RUN echo statements and comments
          BAD=$(grep -R --line-number 'kubectl delete' installer uninstaller nuke \
            | grep -v 'request-timeout' \
            | grep -v '\[DRY-RUN\]' \
            | grep -v '^[^:]*:[^:]*:.*#' \
            | grep -v 'echo.*kubectl delete' || true)

          if [ -n "$BAD" ]; then
            echo "⚠️ kubectl delete without --request-timeout (excluding DRY-RUN and comments):"
            echo "$BAD"
            exit 1
          fi

      # 6) Infinite loop detection (basic)
      - name: Detect infinite loops
        run: |
          set -e
          if grep -R --line-number -E 'while true|while\s+\[\s*1\s*\]' .; then
            echo "❌ Infinite loop detected"
            exit 1
          fi

      # 7) Kyverno bootstrap logic presence check (soft fail)
      - name: Check Kyverno webhook bootstrap logic
        run: |
          if ! grep -R 'failurePolicy.*Ignore' installer uninstaller; then
            echo "⚠️ Kyverno webhook Ignore bootstrap not found"
            exit 1
          fi

      - name: Final status
        run: echo "✅ Static installer/uninstaller checks passed"
