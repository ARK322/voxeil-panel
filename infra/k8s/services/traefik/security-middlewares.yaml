apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: security-headers
  namespace: kube-system
  labels:
    app.kubernetes.io/part-of: voxeil
spec:
  headers:
    accessControlAllowMethods:
      - GET
      - POST
      - PUT
      - DELETE
      - OPTIONS
    accessControlMaxAge: 100
    hostsProxyHeaders:
      - "X-Forwarded-Host"
    referrerPolicy: "same-origin"
    customRequestHeaders:
      X-Forwarded-Proto: "https"
    customResponseHeaders:
      X-Content-Type-Options: "nosniff"
      X-Frame-Options: "DENY"
      X-XSS-Protection: "1; mode=block"
      Referrer-Policy: "strict-origin-when-cross-origin"
      Permissions-Policy: "geolocation=(), microphone=(), camera=()"
---
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: rate-limit
  namespace: kube-system
  labels:
    app.kubernetes.io/part-of: voxeil
spec:
  rateLimit:
    average: 100
    period: 1m
    burst: 50
---
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: sql-injection-protection
  namespace: kube-system
  labels:
    app.kubernetes.io/part-of: voxeil
spec:
  # Rate limiting for suspicious patterns (will be detected by fail2ban)
  rateLimit:
    average: 50
    period: 1m
    burst: 20
  # Request size limit to prevent large payload attacks
  buffering:
    maxRequestBodyBytes: 5242880
    maxResponseBodyBytes: 5242880
---
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: request-size-limit
  namespace: kube-system
  labels:
    app.kubernetes.io/part-of: voxeil
spec:
  buffering:
    maxRequestBodyBytes: 10485760
    maxResponseBodyBytes: 10485760
    memRequestBodyBytes: 2097152
    memResponseBodyBytes: 2097152
    retryExpression: "IsNetworkError() && Attempts() < 3"
