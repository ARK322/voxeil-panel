apiVersion: apps/v1
kind: Deployment
metadata:
  name: pgadmin
  namespace: infra-db
spec:
  replicas: 1
  selector:
    matchLabels:
      app: pgadmin
  template:
    metadata:
      labels:
        app: pgadmin
    spec:
      securityContext:
        fsGroup: 5050
        fsGroupChangePolicy: "Always"
        runAsNonRoot: false
      initContainers:
        - name: init-permissions
          image: alpine:3.19
          command: ["/bin/sh", "-c"]
          args:
            - |
              set -e
              echo "Initializing pgadmin data directory..."
              mkdir -p /var/lib/pgadmin
              # Ensure directory exists and has correct permissions
              chown -R 5050:5050 /var/lib/pgadmin || true
              chmod -R 755 /var/lib/pgadmin || true
              # Create subdirectories that pgadmin4 expects
              mkdir -p /var/lib/pgadmin/storage
              mkdir -p /var/lib/pgadmin/sessions
              chown -R 5050:5050 /var/lib/pgadmin
              chmod -R 700 /var/lib/pgadmin
              echo "Permissions set successfully"
              ls -la /var/lib/pgadmin || true
          securityContext:
            runAsUser: 0
          volumeMounts:
            - name: pgadmin-data
              mountPath: /var/lib/pgadmin
      containers:
        - name: pgadmin
          image: dpage/pgadmin4:8.11
          ports:
            - containerPort: 80
          env:
            - name: PGADMIN_DEFAULT_EMAIL
              valueFrom:
                secretKeyRef:
                  name: pgadmin-secrets
                  key: PGADMIN_EMAIL
            - name: PGADMIN_DEFAULT_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: pgadmin-secrets
                  key: PGADMIN_PASSWORD
            - name: PGADMIN_LISTEN_PORT
              value: "80"
            - name: PGADMIN_CONFIG_SERVER_MODE
              value: "True"
            - name: PGADMIN_CONFIG_MASTER_PASSWORD_REQUIRED
              value: "False"
            - name: PGADMIN_CONFIG_WTF_CSRF_ENABLED
              value: "True"
            - name: PGADMIN_CONFIG_WTF_CSRF_TIME_LIMIT
              value: "None"
          volumeMounts:
            - name: pgadmin-data
              mountPath: /var/lib/pgadmin
          resources:
            requests:
              memory: "256Mi"
              cpu: "100m"
            limits:
              memory: "1Gi"
              cpu: "500m"
          startupProbe:
            httpGet:
              path: /misc/ping
              port: 80
            initialDelaySeconds: 10
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 30
          readinessProbe:
            httpGet:
              path: /misc/ping
              port: 80
            initialDelaySeconds: 5
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          livenessProbe:
            httpGet:
              path: /misc/ping
              port: 80
            initialDelaySeconds: 60
            periodSeconds: 20
            timeoutSeconds: 5
            failureThreshold: 3
          securityContext:
            # pgadmin4 image requires root for initialization, then switches to 5050 internally
            # Explicitly set runAsUser/runAsGroup to 0 to avoid Kyverno/cert-manager conflicts
            runAsUser: 0
            runAsGroup: 0
            allowPrivilegeEscalation: true
            readOnlyRootFilesystem: false
            seccompProfile:
              type: RuntimeDefault
            capabilities:
              drop:
                - ALL
              add:
                - CHOWN
                - FOWNER
                - DAC_OVERRIDE
                - SETGID
                - SETUID
      volumes:
        - name: pgadmin-data
          persistentVolumeClaim:
            claimName: pgadmin-pvc
