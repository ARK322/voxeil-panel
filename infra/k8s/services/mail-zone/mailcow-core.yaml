apiVersion: v1
kind: ConfigMap
metadata:
  name: mailcow-config
  namespace: mail-zone
data:
  MAILCOW_HOSTNAME: "REPLACE_MAILCOW_HOSTNAME"
  TZ: "UTC"
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: mailcow-vmail
  namespace: mail-zone
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 20Gi
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: mailcow-mysql
  namespace: mail-zone
spec:
  serviceName: mailcow-mysql
  replicas: 1
  selector:
    matchLabels:
      app: mailcow
      component: mysql
  template:
    metadata:
      labels:
        app: mailcow
        component: mysql
    spec:
      containers:
        - name: mysql
          image: mailcow/mysql-mailcow:latest
          ports:
            - containerPort: 3306
              name: mysql
          env:
            - name: MYSQL_ROOT_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: mailcow-secrets
                  key: MYSQL_ROOT_PASSWORD
            - name: MYSQL_DATABASE
              valueFrom:
                secretKeyRef:
                  name: mailcow-secrets
                  key: MYSQL_DATABASE
            - name: MYSQL_USER
              valueFrom:
                secretKeyRef:
                  name: mailcow-secrets
                  key: MYSQL_USER
            - name: MYSQL_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: mailcow-secrets
                  key: MYSQL_PASSWORD
          volumeMounts:
            - name: mysql-data
              mountPath: /var/lib/mysql
  volumeClaimTemplates:
    - metadata:
        name: mysql-data
      spec:
        accessModes:
          - ReadWriteOnce
        resources:
          requests:
            storage: 10Gi
---
apiVersion: v1
kind: Service
metadata:
  name: mailcow-mysql
  namespace: mail-zone
spec:
  type: ClusterIP
  selector:
    app: mailcow
    component: mysql
  ports:
    - name: mysql
      port: 3306
      targetPort: 3306
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mailcow-redis
  namespace: mail-zone
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mailcow
      component: redis
  template:
    metadata:
      labels:
        app: mailcow
        component: redis
    spec:
      containers:
        - name: redis
          image: mailcow/redis-mailcow:latest
          ports:
            - containerPort: 6379
              name: redis
---
apiVersion: v1
kind: Service
metadata:
  name: mailcow-redis
  namespace: mail-zone
spec:
  type: ClusterIP
  selector:
    app: mailcow
    component: redis
  ports:
    - name: redis
      port: 6379
      targetPort: 6379
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mailcow-php-fpm
  namespace: mail-zone
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mailcow
      component: php-fpm
  template:
    metadata:
      labels:
        app: mailcow
        component: php-fpm
    spec:
      containers:
        - name: php-fpm
          image: mailcow/php-fpm-mailcow:latest
          env:
            - name: DBNAME
              valueFrom:
                secretKeyRef:
                  name: mailcow-secrets
                  key: MYSQL_DATABASE
            - name: DBUSER
              valueFrom:
                secretKeyRef:
                  name: mailcow-secrets
                  key: MYSQL_USER
            - name: DBPASS
              valueFrom:
                secretKeyRef:
                  name: mailcow-secrets
                  key: MYSQL_PASSWORD
            - name: DBHOST
              value: mailcow-mysql.mail-zone.svc.cluster.local
            - name: REDIS_HOST
              value: mailcow-redis.mail-zone.svc.cluster.local
            - name: MAILCOW_HOSTNAME
              valueFrom:
                configMapKeyRef:
                  name: mailcow-config
                  key: MAILCOW_HOSTNAME
            - name: TZ
              valueFrom:
                configMapKeyRef:
                  name: mailcow-config
                  key: TZ
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mailcow-nginx
  namespace: mail-zone
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mailcow
      component: nginx
  template:
    metadata:
      labels:
        app: mailcow
        component: nginx
    spec:
      containers:
        - name: nginx
          image: mailcow/nginx-mailcow:latest
          ports:
            - containerPort: 80
              name: http
          env:
            - name: PHPFPM_HOST
              value: mailcow-php-fpm.mail-zone.svc.cluster.local
            - name: MAILCOW_HOSTNAME
              valueFrom:
                configMapKeyRef:
                  name: mailcow-config
                  key: MAILCOW_HOSTNAME
            - name: TZ
              valueFrom:
                configMapKeyRef:
                  name: mailcow-config
                  key: TZ
---
apiVersion: v1
kind: Service
metadata:
  name: mailcow-api
  namespace: mail-zone
spec:
  type: ClusterIP
  selector:
    app: mailcow
    component: nginx
  ports:
    - name: http
      port: 80
      targetPort: 80
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mailcow-postfix
  namespace: mail-zone
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mailcow
      component: postfix
  template:
    metadata:
      labels:
        app: mailcow
        component: postfix
    spec:
      containers:
        - name: postfix
          image: mailcow/postfix-mailcow:latest
          ports:
            - containerPort: 25
              name: smtp
            - containerPort: 465
              name: smtps
            - containerPort: 587
              name: submission
          env:
            - name: DBNAME
              valueFrom:
                secretKeyRef:
                  name: mailcow-secrets
                  key: MYSQL_DATABASE
            - name: DBUSER
              valueFrom:
                secretKeyRef:
                  name: mailcow-secrets
                  key: MYSQL_USER
            - name: DBPASS
              valueFrom:
                secretKeyRef:
                  name: mailcow-secrets
                  key: MYSQL_PASSWORD
            - name: DBHOST
              value: mailcow-mysql.mail-zone.svc.cluster.local
            - name: MAILCOW_HOSTNAME
              valueFrom:
                configMapKeyRef:
                  name: mailcow-config
                  key: MAILCOW_HOSTNAME
            - name: TZ
              valueFrom:
                configMapKeyRef:
                  name: mailcow-config
                  key: TZ
          volumeMounts:
            - name: vmail
              mountPath: /var/vmail
      volumes:
        - name: vmail
          persistentVolumeClaim:
            claimName: mailcow-vmail
---
apiVersion: v1
kind: Service
metadata:
  name: mailcow-smtp
  namespace: mail-zone
spec:
  type: ClusterIP
  selector:
    app: mailcow
    component: postfix
  ports:
    - name: smtp
      port: 25
      targetPort: 25
    - name: smtps
      port: 465
      targetPort: 465
    - name: submission
      port: 587
      targetPort: 587
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mailcow-dovecot
  namespace: mail-zone
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mailcow
      component: dovecot
  template:
    metadata:
      labels:
        app: mailcow
        component: dovecot
    spec:
      containers:
        - name: dovecot
          image: mailcow/dovecot-mailcow:latest
          ports:
            - containerPort: 143
              name: imap
            - containerPort: 993
              name: imaps
            - containerPort: 110
              name: pop3
            - containerPort: 995
              name: pop3s
          env:
            - name: DBNAME
              valueFrom:
                secretKeyRef:
                  name: mailcow-secrets
                  key: MYSQL_DATABASE
            - name: DBUSER
              valueFrom:
                secretKeyRef:
                  name: mailcow-secrets
                  key: MYSQL_USER
            - name: DBPASS
              valueFrom:
                secretKeyRef:
                  name: mailcow-secrets
                  key: MYSQL_PASSWORD
            - name: DBHOST
              value: mailcow-mysql.mail-zone.svc.cluster.local
            - name: MAILCOW_HOSTNAME
              valueFrom:
                configMapKeyRef:
                  name: mailcow-config
                  key: MAILCOW_HOSTNAME
            - name: TZ
              valueFrom:
                configMapKeyRef:
                  name: mailcow-config
                  key: TZ
          volumeMounts:
            - name: vmail
              mountPath: /var/vmail
      volumes:
        - name: vmail
          persistentVolumeClaim:
            claimName: mailcow-vmail
---
apiVersion: v1
kind: Service
metadata:
  name: mailcow-imap
  namespace: mail-zone
spec:
  type: ClusterIP
  selector:
    app: mailcow
    component: dovecot
  ports:
    - name: imap
      port: 143
      targetPort: 143
    - name: imaps
      port: 993
      targetPort: 993
---
apiVersion: v1
kind: Service
metadata:
  name: mailcow-pop3
  namespace: mail-zone
spec:
  type: ClusterIP
  selector:
    app: mailcow
    component: dovecot
  ports:
    - name: pop3
      port: 110
      targetPort: 110
    - name: pop3s
      port: 995
      targetPort: 995
